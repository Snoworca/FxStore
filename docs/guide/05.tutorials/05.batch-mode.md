---
name: BATCH 모드
description: BATCH 커밋 모드, 명시적 commit/rollback 사용법
---

# Tutorial 05: BATCH 모드

> **예상 시간**: 15분
> **난이도**: 중급
> **선행 조건**: 기초 튜토리얼 01-04

## 학습 목표

- AUTO vs BATCH 모드 차이 이해
- 명시적 commit() 사용
- rollback() 사용
- 대량 데이터 처리 최적화

## 1. AUTO vs BATCH

### AUTO 모드 (기본값)

```java
// AUTO 모드
FxStore store = FxStore.open(path);

map.put(1L, "A");  // 즉시 디스크에 저장
map.put(2L, "B");  // 즉시 디스크에 저장
// 여기서 크래시 발생해도 A, B 모두 안전
```

### BATCH 모드

```java
// BATCH 모드
FxOptions options = FxOptions.defaults()
    .withCommitMode(CommitMode.BATCH)
    .build();
FxStore store = FxStore.open(path, options);

map.put(1L, "A");  // 메모리에만
map.put(2L, "B");  // 메모리에만
// 여기서 크래시 발생하면 A, B 모두 손실

store.commit();    // 이제 디스크에 저장
// 여기서 크래시 발생해도 A, B 모두 안전
```

## 2. 기본 사용법

```java
import com.snoworca.fxstore.api.*;
import java.nio.file.Paths;
import java.util.NavigableMap;

public class BatchModeBasics {
    public static void main(String[] args) {
        FxOptions options = FxOptions.defaults()
            .withCommitMode(CommitMode.BATCH)
            .build();

        FxStore store = FxStore.open(Paths.get("batch.fx"), options);

        NavigableMap<Long, String> users = store.createOrOpenMap(
            "users", Long.class, String.class);

        try {
            users.put(1L, "Alice");
            users.put(2L, "Bob");

            // 커밋 - 변경사항 저장
            store.commit();
            System.out.println("Changes committed");

        } catch (Exception e) {
            // 롤백 - 변경사항 취소
            store.rollback();
            System.out.println("Changes rolled back");
        }

        store.close();
    }
}
```

## 3. Rollback 사용

```java
FxStore store = FxStore.open(path, batchOptions);
NavigableMap<Long, String> map = store.createOrOpenMap(
    "data", Long.class, String.class);

// 초기 데이터
map.put(1L, "Original");
store.commit();

// 변경 시도
map.put(1L, "Modified");
map.put(2L, "New");

// 롤백
store.rollback();

// 확인
System.out.println(map.get(1L));  // "Original" (롤백됨)
System.out.println(map.get(2L));  // null (롤백됨)
```

## 4. 대량 데이터 처리

BATCH 모드는 대량 삽입에 효율적입니다.

```java
FxOptions options = FxOptions.defaults()
    .withCommitMode(CommitMode.BATCH)
    .withDurability(Durability.ASYNC)  // 추가 성능 향상
    .build();

FxStore store = FxStore.open(path, options);
NavigableMap<Long, String> data = store.createOrOpenMap(
    "data", Long.class, String.class);

long startTime = System.currentTimeMillis();

// 100만 건 삽입
for (long i = 0; i < 1_000_000; i++) {
    data.put(i, "Value " + i);

    // 10만 건마다 커밋 (메모리 관리)
    if (i % 100_000 == 0 && i > 0) {
        store.commit();
        System.out.println("Committed " + i + " records");
    }
}

// 마지막 커밋
store.commit();

long elapsed = System.currentTimeMillis() - startTime;
System.out.println("Inserted 1M records in " + elapsed + "ms");

store.close();
```

## 5. 커밋 모드 확인

```java
CommitMode mode = store.commitMode();
if (mode == CommitMode.BATCH) {
    System.out.println("Remember to call commit()!");
}
```

## 6. OnClosePolicy

Store를 닫을 때 미커밋 변경이 있으면:

| 정책 | 동작 |
|------|------|
| `ERROR` (기본) | 예외 발생 |
| `COMMIT` | 자동 커밋 |
| `ROLLBACK` | 자동 롤백 |

```java
FxOptions options = FxOptions.defaults()
    .withCommitMode(CommitMode.BATCH)
    .withOnClosePolicy(OnClosePolicy.ROLLBACK)  // 닫을 때 자동 롤백
    .build();
```

## 7. 트랜잭션 패턴

```java
public void transferFunds(long fromId, long toId, int amount) {
    FxStore store = FxStore.open(path, batchOptions);
    NavigableMap<Long, Integer> accounts = store.openMap(
        "accounts", Long.class, Integer.class);

    try {
        int fromBalance = accounts.get(fromId);
        int toBalance = accounts.get(toId);

        if (fromBalance < amount) {
            throw new RuntimeException("Insufficient funds");
        }

        accounts.put(fromId, fromBalance - amount);
        accounts.put(toId, toBalance + amount);

        store.commit();  // 두 변경이 함께 저장

    } catch (Exception e) {
        store.rollback();  // 둘 다 취소
        throw e;
    } finally {
        store.close();
    }
}
```

## 성능 비교

| 모드 | 10만 건 삽입 | 안전성 |
|------|-------------|--------|
| AUTO | ~30초 | 매우 높음 |
| BATCH | ~3초 | 커밋 단위 |
| BATCH + ASYNC | ~1초 | 낮음 |

## 언제 사용하나?

| 상황 | 권장 |
|------|------|
| 실시간 데이터 | AUTO |
| 대량 삽입 | BATCH |
| 관련 변경 묶음 | BATCH |
| 롤백 필요 | BATCH |
| 최대 안전성 | AUTO + SYNC |

## 다음 단계

- [읽기 트랜잭션](06.read-transaction.md)
- [성능 튜닝](08.performance.md)
