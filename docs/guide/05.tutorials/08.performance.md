---
name: 성능 튜닝
description: FxStore 성능 최적화 방법
---

# Tutorial 08: 성능 튜닝

> **예상 시간**: 20분
> **난이도**: 고급
> **선행 조건**: 모든 기초/중급 튜토리얼

## 학습 목표

- 페이지 크기 최적화
- 캐시 크기 조정
- BATCH 모드 활용
- 대용량 데이터 처리 전략

## 1. 기본 성능 옵션

```java
FxOptions options = FxOptions.defaults()
    .withPageSize(PageSize.PAGE_16K)      // 페이지 크기
    .withCacheBytes(128 * 1024 * 1024)    // 캐시 크기 (128MB)
    .withCommitMode(CommitMode.BATCH)     // 배치 모드
    .withDurability(Durability.ASYNC)     // 비동기 쓰기
    .build();

FxStore store = FxStore.open(path, options);
```

## 2. 페이지 크기

페이지는 디스크 I/O의 기본 단위입니다.

| 페이지 크기 | 적합한 상황 |
|------------|------------|
| 4K (기본) | 작은 값, 일반적 사용 |
| 8K | 중간 크기 값 |
| 16K | 1KB 이상 값 |
| 32K | 대용량 값 |
| 64K | 매우 큰 값 |

**선택 가이드**:
- 값 크기의 평균이 페이지의 1/10~1/5 정도가 적절
- 너무 크면 공간 낭비, 너무 작으면 분할 오버헤드

```java
// 평균 값 크기가 2KB인 경우
FxOptions options = FxOptions.defaults()
    .withPageSize(PageSize.PAGE_16K)  // 2KB * 5~10 = 16K 적절
    .build();
```

## 3. 캐시 크기

캐시는 자주 접근하는 페이지를 메모리에 유지합니다.

```java
// 캐시 크기 설정
FxOptions options = FxOptions.defaults()
    .withCacheBytes(256 * 1024 * 1024)  // 256MB
    .build();
```

**권장 설정**:
- 워킹셋이 캐시에 들어가면 성능 최적
- 가용 메모리의 25~50% 권장
- 너무 크면 GC 부담 증가

```java
// 시스템 메모리 기반 동적 설정
long maxMemory = Runtime.getRuntime().maxMemory();
long cacheSize = maxMemory / 4;  // 최대 힙의 25%

FxOptions options = FxOptions.defaults()
    .withCacheBytes(cacheSize)
    .build();
```

## 4. BATCH 모드 최적화

대량 데이터 처리 시 BATCH 모드가 필수입니다.

```java
FxOptions options = FxOptions.defaults()
    .withCommitMode(CommitMode.BATCH)
    .withDurability(Durability.ASYNC)
    .build();

FxStore store = FxStore.open(path, options);
NavigableMap<Long, byte[]> data = store.createOrOpenMap(
    "data", Long.class, byte[].class);

// 대량 삽입
int batchSize = 10_000;
for (long i = 0; i < 1_000_000; i++) {
    data.put(i, new byte[1024]);

    // 주기적 커밋 (메모리 관리)
    if (i % batchSize == 0 && i > 0) {
        store.commit();
    }
}
store.commit();  // 마지막 배치
```

**배치 크기 권장**:
- 너무 작으면: 커밋 오버헤드 증가
- 너무 크면: 메모리 사용량 증가, 롤백 시 손실 증가
- 보통 1만~10만 건 권장

## 5. 내구성 설정

| 설정 | 성능 | 안전성 |
|------|------|--------|
| `SYNC` | 느림 | 높음 |
| `ASYNC` | 빠름 | 낮음 |

```java
// 최대 성능 (데이터 손실 가능)
FxOptions fast = FxOptions.defaults()
    .withDurability(Durability.ASYNC)
    .build();

// 최대 안전성 (느림)
FxOptions safe = FxOptions.defaults()
    .withDurability(Durability.SYNC)
    .build();
```

## 6. 벤치마크 예제

```java
public class Benchmark {
    public static void main(String[] args) throws Exception {
        Path path = Paths.get("benchmark.fx");
        Files.deleteIfExists(path);

        // 성능 최적화 설정
        FxOptions options = FxOptions.defaults()
            .withCommitMode(CommitMode.BATCH)
            .withDurability(Durability.ASYNC)
            .withPageSize(PageSize.PAGE_16K)
            .withCacheBytes(256 * 1024 * 1024)
            .build();

        FxStore store = FxStore.open(path, options);
        NavigableMap<Long, String> map = store.createOrOpenMap(
            "bench", Long.class, String.class);

        int count = 1_000_000;
        String value = "x".repeat(100);  // 100바이트 값

        // 쓰기 벤치마크
        long writeStart = System.nanoTime();
        for (long i = 0; i < count; i++) {
            map.put(i, value);
            if (i % 100_000 == 0 && i > 0) {
                store.commit();
            }
        }
        store.commit();
        long writeTime = System.nanoTime() - writeStart;
        System.out.printf("Write: %d ops in %.2f sec (%.0f ops/sec)%n",
            count, writeTime / 1e9, count / (writeTime / 1e9));

        // 읽기 벤치마크
        long readStart = System.nanoTime();
        for (long i = 0; i < count; i++) {
            map.get(i);
        }
        long readTime = System.nanoTime() - readStart;
        System.out.printf("Read: %d ops in %.2f sec (%.0f ops/sec)%n",
            count, readTime / 1e9, count / (readTime / 1e9));

        store.close();
    }
}
```

## 7. 성능 팁

### 키 설계
- 짧은 키가 유리 (비교 비용 감소)
- 순차 키가 랜덤 키보다 빠름 (트리 밸런싱)

### 값 설계
- 압축 고려 (큰 값은 압축 후 저장)
- 불필요한 필드 제외

### 접근 패턴
- 핫 데이터를 함께 접근 (캐시 활용)
- 범위 조회 시 연속 키 사용

### 컴팩션
```java
// 삭제가 많으면 주기적 컴팩션
store.compactTo(newPath);
```

## 8. 성능 설정 조합

| 사용 사례 | 설정 조합 |
|----------|----------|
| 대량 삽입 | BATCH + ASYNC + 큰 페이지 |
| 실시간 저장 | AUTO + SYNC + 기본 페이지 |
| 읽기 위주 | 큰 캐시 |
| 메모리 제한 | 작은 캐시 + 작은 페이지 |

## 다음 단계

- [API 레퍼런스: FxOptions](../06.api-reference/fxoptions.md)
- [문제 해결](../08.troubleshooting.md)
