---
name: 문제 해결
description: FxStore 사용 시 발생할 수 있는 일반적인 문제와 해결 방법
---

# 문제 해결

## Store 열기 문제

### Store가 열리지 않음

**증상**: `FxException(IO)` 발생

**원인 및 해결**:

1. **파일 경로 오류**
   ```java
   // 오류: 존재하지 않는 디렉토리
   FxStore.open(Paths.get("/nonexistent/dir/data.fx"));

   // 해결: 디렉토리 먼저 생성
   Files.createDirectories(Paths.get("/mydir"));
   FxStore.open(Paths.get("/mydir/data.fx"));
   ```

2. **파일 권한 문제**
   ```bash
   # 해결: 파일 권한 확인
   chmod 644 data.fx
   ```

3. **다른 프로세스가 파일 사용 중**
   ```java
   // 해결: FileLockMode.NONE 사용 (주의: 동시 쓰기 불가)
   FxOptions options = FxOptions.defaults()
       .withFileLock(FileLockMode.NONE)
       .build();
   ```

### 파일이 손상됨

**증상**: `FxException(CORRUPTED)` 발생

**해결**:
1. 백업에서 복원
2. `verify()` 실행하여 손상 범위 확인
3. 손상이 심하면 새 Store 생성

## 데이터 저장 문제

### 데이터가 저장되지 않음

**증상**: 재시작 후 데이터 없음

**원인 및 해결**:

1. **BATCH 모드에서 commit() 누락**
   ```java
   // 오류
   map.put(1L, "value");
   store.close();  // commit 안 함!

   // 해결
   map.put(1L, "value");
   store.commit();  // 명시적 커밋
   store.close();
   ```

2. **메모리 모드 사용**
   ```java
   // 오류: 메모리 모드는 영속 아님
   FxStore store = FxStore.openMemory();

   // 해결: 파일 모드 사용
   FxStore store = FxStore.open(Paths.get("data.fx"));
   ```

3. **OnClosePolicy.ROLLBACK 설정**
   ```java
   // 확인
   if (options.onClosePolicy() == OnClosePolicy.ROLLBACK) {
       // 닫기 전 수동 커밋 필요
       store.commit();
   }
   ```

### 코덱 오류

**증상**: `FxException(CODEC_NOT_FOUND)` 또는 `CODEC_MISMATCH`

**해결**:
```java
// 커스텀 타입 사용 전 코덱 등록
store.registerCodec(User.class, new UserCodec());

// 그 후 컬렉션 생성/열기
NavigableMap<Long, User> users = store.createOrOpenMap(...);
```

## 성능 문제

### 쓰기가 느림

**원인 및 해결**:

1. **AUTO 모드에서 대량 삽입**
   ```java
   // 느림: 매번 커밋
   for (long i = 0; i < 1_000_000; i++) {
       map.put(i, "value");  // 각각 디스크 쓰기
   }

   // 빠름: BATCH 모드
   FxOptions options = FxOptions.defaults()
       .withCommitMode(CommitMode.BATCH)
       .build();
   for (long i = 0; i < 1_000_000; i++) {
       map.put(i, "value");
       if (i % 100_000 == 0) store.commit();
   }
   store.commit();
   ```

2. **SYNC 모드 사용**
   ```java
   // 느림
   .withDurability(Durability.SYNC)

   // 빠름 (안전성 감소)
   .withDurability(Durability.ASYNC)
   ```

### 읽기가 느림

**원인 및 해결**:

1. **캐시 부족**
   ```java
   // 캐시 증가
   FxOptions options = FxOptions.defaults()
       .withCacheBytes(256 * 1024 * 1024)  // 256MB
       .build();
   ```

2. **페이지 크기 불일치**
   ```java
   // 큰 값에 작은 페이지
   .withPageSize(PageSize.PAGE_16K)  // 증가
   ```

### 메모리 사용량 과다

**해결**:
1. 캐시 크기 감소
2. 주기적 커밋으로 버퍼 정리
3. 메모리 모드에서 memoryLimitBytes 설정

## 동시성 문제

### 파일 잠금 충돌

**증상**: 다른 프로세스에서 Store 열기 실패

**해결**:
- 하나의 프로세스만 Store 사용
- 필요시 `FileLockMode.NONE` (동시 쓰기 불가)

### 읽기 트랜잭션 오류

**증상**: `IllegalStateException` - 트랜잭션이 닫힘

**해결**:
```java
// 오류: 트랜잭션 범위 벗어남
FxReadTransaction tx = store.beginRead();
tx.close();
tx.get(map, key);  // 예외!

// 해결: try-with-resources 사용
try (FxReadTransaction tx = store.beginRead()) {
    return tx.get(map, key);
}
```

## 일반적인 오류 메시지

| 메시지 | 원인 | 해결 |
|--------|------|------|
| "Collection not found" | 존재하지 않는 컬렉션 열기 | createOrOpen 사용 |
| "Collection already exists" | 이미 존재하는 컬렉션 생성 | createOrOpen 사용 |
| "Key cannot be null" | null 키 사용 | null 체크 |
| "Store is closed" | 닫힌 Store 사용 | 열린 Store 확인 |
| "Codec not registered" | 미등록 타입 | registerCodec 호출 |

## 디버깅 팁

### 통계 확인
```java
Stats stats = store.stats();
System.out.println("Pages: " + stats.pageCount());
System.out.println("Used: " + stats.usedBytes());
```

### 무결성 검증
```java
VerifyResult result = store.verify();
if (!result.isOk()) {
    for (VerifyError e : result.errors()) {
        System.err.println(e.kind() + ": " + e.message());
    }
}
```

### 컬렉션 목록 확인
```java
for (CollectionInfo info : store.list()) {
    System.out.println(info.name() + " (" + info.kind() + ")");
}
```
