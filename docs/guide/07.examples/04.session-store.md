---
name: 세션 스토어 예제
description: FxStore를 사용한 서버 세션 저장소 구현 예제
---

# 예제: 세션 스토어

웹 애플리케이션의 서버 측 세션을 영속적으로 저장하는 예제입니다.

## 시나리오

- 사용자 로그인 시 세션 생성
- 세션 ID로 세션 데이터 조회/업데이트
- 세션 만료 자동 정리
- 서버 재시작 시 세션 유지

## 전체 코드

```java
import com.snoworca.fxstore.api.*;
import java.nio.ByteBuffer;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.time.Duration;
import java.time.Instant;
import java.util.*;
import java.util.concurrent.ConcurrentHashMap;

public class SessionStoreExample {

    // 세션 데이터
    public static class Session {
        public final String sessionId;
        public final String userId;
        public final Map<String, String> attributes;
        public final Instant createdAt;
        public Instant lastAccessedAt;
        public final Duration timeout;

        public Session(String userId, Duration timeout) {
            this(UUID.randomUUID().toString(), userId, new HashMap<>(),
                 Instant.now(), Instant.now(), timeout);
        }

        public Session(String sessionId, String userId, Map<String, String> attributes,
                      Instant createdAt, Instant lastAccessedAt, Duration timeout) {
            this.sessionId = sessionId;
            this.userId = userId;
            this.attributes = attributes;
            this.createdAt = createdAt;
            this.lastAccessedAt = lastAccessedAt;
            this.timeout = timeout;
        }

        public void touch() {
            this.lastAccessedAt = Instant.now();
        }

        public boolean isExpired() {
            return Instant.now().isAfter(lastAccessedAt.plus(timeout));
        }

        public void setAttribute(String key, String value) {
            attributes.put(key, value);
            touch();
        }

        public String getAttribute(String key) {
            touch();
            return attributes.get(key);
        }

        @Override
        public String toString() {
            return String.format("Session[%s, user=%s, attrs=%d, expired=%s]",
                sessionId.substring(0, 8), userId, attributes.size(), isExpired());
        }
    }

    // Session 코덱
    public static class SessionCodec implements FxCodec<Session> {
        @Override
        public byte[] encode(Session session) {
            byte[] sessionIdBytes = session.sessionId.getBytes(java.nio.charset.StandardCharsets.UTF_8);
            byte[] userIdBytes = session.userId.getBytes(java.nio.charset.StandardCharsets.UTF_8);

            // 속성을 직렬화
            ByteBuffer attrBuffer = ByteBuffer.allocate(4096);
            attrBuffer.putInt(session.attributes.size());
            for (Map.Entry<String, String> entry : session.attributes.entrySet()) {
                byte[] keyBytes = entry.getKey().getBytes(java.nio.charset.StandardCharsets.UTF_8);
                byte[] valueBytes = entry.getValue().getBytes(java.nio.charset.StandardCharsets.UTF_8);
                attrBuffer.putInt(keyBytes.length);
                attrBuffer.put(keyBytes);
                attrBuffer.putInt(valueBytes.length);
                attrBuffer.put(valueBytes);
            }
            int attrSize = attrBuffer.position();
            byte[] attrBytes = new byte[attrSize];
            attrBuffer.flip();
            attrBuffer.get(attrBytes);

            int totalSize = 4 + sessionIdBytes.length + 4 + userIdBytes.length +
                           attrSize + 8 + 8 + 8;

            ByteBuffer buffer = ByteBuffer.allocate(totalSize);
            buffer.putInt(sessionIdBytes.length);
            buffer.put(sessionIdBytes);
            buffer.putInt(userIdBytes.length);
            buffer.put(userIdBytes);
            buffer.put(attrBytes);
            buffer.putLong(session.createdAt.toEpochMilli());
            buffer.putLong(session.lastAccessedAt.toEpochMilli());
            buffer.putLong(session.timeout.toMillis());

            return buffer.array();
        }

        @Override
        public Session decode(byte[] bytes) {
            ByteBuffer buffer = ByteBuffer.wrap(bytes);

            int sessionIdLen = buffer.getInt();
            byte[] sessionIdBytes = new byte[sessionIdLen];
            buffer.get(sessionIdBytes);
            String sessionId = new String(sessionIdBytes, java.nio.charset.StandardCharsets.UTF_8);

            int userIdLen = buffer.getInt();
            byte[] userIdBytes = new byte[userIdLen];
            buffer.get(userIdBytes);
            String userId = new String(userIdBytes, java.nio.charset.StandardCharsets.UTF_8);

            int attrCount = buffer.getInt();
            Map<String, String> attributes = new HashMap<>();
            for (int i = 0; i < attrCount; i++) {
                int keyLen = buffer.getInt();
                byte[] keyBytes = new byte[keyLen];
                buffer.get(keyBytes);
                String key = new String(keyBytes, java.nio.charset.StandardCharsets.UTF_8);

                int valueLen = buffer.getInt();
                byte[] valueBytes = new byte[valueLen];
                buffer.get(valueBytes);
                String value = new String(valueBytes, java.nio.charset.StandardCharsets.UTF_8);

                attributes.put(key, value);
            }

            long createdAt = buffer.getLong();
            long lastAccessedAt = buffer.getLong();
            long timeoutMillis = buffer.getLong();

            return new Session(sessionId, userId, attributes,
                Instant.ofEpochMilli(createdAt),
                Instant.ofEpochMilli(lastAccessedAt),
                Duration.ofMillis(timeoutMillis));
        }
    }

    // 세션 저장소
    public static class SessionStore implements AutoCloseable {
        private final FxStore store;
        private final NavigableMap<String, Session> sessions;
        private final NavigableMap<String, String> userToSession;  // userId -> sessionId

        public SessionStore(Path path) {
            FxOptions options = FxOptions.defaults()
                .withCommitMode(CommitMode.AUTO)
                .build();

            this.store = FxStore.open(path, options);
            this.store.registerCodec(Session.class, new SessionCodec());

            this.sessions = store.createOrOpenMap("sessions", String.class, Session.class);
            this.userToSession = store.createOrOpenMap("user_sessions", String.class, String.class);
        }

        // 세션 생성
        public Session createSession(String userId, Duration timeout) {
            // 기존 세션 무효화
            String existingSessionId = userToSession.get(userId);
            if (existingSessionId != null) {
                invalidate(existingSessionId);
            }

            Session session = new Session(userId, timeout);
            sessions.put(session.sessionId, session);
            userToSession.put(userId, session.sessionId);

            System.out.println("Created session: " + session);
            return session;
        }

        // 세션 조회
        public Session getSession(String sessionId) {
            Session session = sessions.get(sessionId);
            if (session == null) {
                return null;
            }
            if (session.isExpired()) {
                invalidate(sessionId);
                return null;
            }
            // 접근 시간 갱신
            session.touch();
            sessions.put(sessionId, session);
            return session;
        }

        // 사용자 ID로 세션 조회
        public Session getSessionByUserId(String userId) {
            String sessionId = userToSession.get(userId);
            if (sessionId == null) {
                return null;
            }
            return getSession(sessionId);
        }

        // 세션 업데이트
        public void updateSession(Session session) {
            session.touch();
            sessions.put(session.sessionId, session);
        }

        // 세션 무효화
        public void invalidate(String sessionId) {
            Session session = sessions.remove(sessionId);
            if (session != null) {
                userToSession.remove(session.userId);
                System.out.println("Invalidated session: " + sessionId.substring(0, 8));
            }
        }

        // 만료 세션 정리
        public int cleanupExpired() {
            List<String> expiredIds = new ArrayList<>();
            for (Map.Entry<String, Session> entry : sessions.entrySet()) {
                if (entry.getValue().isExpired()) {
                    expiredIds.add(entry.getKey());
                }
            }
            for (String id : expiredIds) {
                invalidate(id);
            }
            if (!expiredIds.isEmpty()) {
                System.out.println("Cleaned up " + expiredIds.size() + " expired sessions");
            }
            return expiredIds.size();
        }

        // 활성 세션 수
        public int activeSessionCount() {
            int count = 0;
            for (Session session : sessions.values()) {
                if (!session.isExpired()) {
                    count++;
                }
            }
            return count;
        }

        // 모든 세션 조회 (관리용)
        public Collection<Session> getAllSessions() {
            return sessions.values();
        }

        @Override
        public void close() {
            store.close();
        }
    }

    public static void main(String[] args) throws InterruptedException {
        Path storePath = Paths.get("sessions.fx");

        try (SessionStore store = new SessionStore(storePath)) {
            // 기존 세션 확인
            System.out.println("=== 기존 세션 확인 ===");
            System.out.println("Active sessions: " + store.activeSessionCount());

            // 만료 세션 정리
            store.cleanupExpired();

            // 세션 생성
            System.out.println("\n=== 세션 생성 ===");
            Duration timeout = Duration.ofMinutes(30);

            Session alice = store.createSession("alice", timeout);
            Session bob = store.createSession("bob", timeout);

            // 세션 속성 설정
            System.out.println("\n=== 세션 속성 설정 ===");
            alice.setAttribute("role", "admin");
            alice.setAttribute("theme", "dark");
            store.updateSession(alice);

            bob.setAttribute("role", "user");
            bob.setAttribute("cart", "item1,item2,item3");
            store.updateSession(bob);

            // 세션 조회
            System.out.println("\n=== 세션 조회 ===");
            Session retrieved = store.getSession(alice.sessionId);
            System.out.println("Alice's role: " + retrieved.getAttribute("role"));
            System.out.println("Alice's theme: " + retrieved.getAttribute("theme"));

            // 사용자 ID로 조회
            Session bobSession = store.getSessionByUserId("bob");
            System.out.println("Bob's cart: " + bobSession.getAttribute("cart"));

            // 세션 무효화 (로그아웃)
            System.out.println("\n=== 로그아웃 ===");
            store.invalidate(bob.sessionId);

            // Bob 재로그인
            Session bobNew = store.createSession("bob", timeout);
            System.out.println("Bob new session: " + bobNew);

            // 짧은 타임아웃으로 세션 생성
            System.out.println("\n=== 만료 테스트 ===");
            Session shortLived = store.createSession("charlie", Duration.ofSeconds(1));
            System.out.println("Charlie session created");

            // 만료 대기
            Thread.sleep(1500);

            // 만료 확인
            Session expired = store.getSession(shortLived.sessionId);
            System.out.println("Charlie session after timeout: " + (expired == null ? "expired" : "active"));

            // 최종 상태
            System.out.println("\n=== 최종 상태 ===");
            System.out.println("Active sessions: " + store.activeSessionCount());
            for (Session s : store.getAllSessions()) {
                System.out.println("  " + s);
            }
        }
    }
}
```

## 실행 결과 (예시)

```
=== 기존 세션 확인 ===
Active sessions: 0

=== 세션 생성 ===
Created session: Session[abc12345, user=alice, attrs=0, expired=false]
Created session: Session[def67890, user=bob, attrs=0, expired=false]

=== 세션 속성 설정 ===

=== 세션 조회 ===
Alice's role: admin
Alice's theme: dark
Bob's cart: item1,item2,item3

=== 로그아웃 ===
Invalidated session: def67890
Created session: Session[ghi11111, user=bob, attrs=0, expired=false]
Bob new session: Session[ghi11111, user=bob, attrs=0, expired=false]

=== 만료 테스트 ===
Created session: Session[jkl22222, user=charlie, attrs=0, expired=false]
Charlie session created
Invalidated session: jkl22222
Charlie session after timeout: expired

=== 최종 상태 ===
Active sessions: 2
  Session[abc12345, user=alice, attrs=2, expired=false]
  Session[ghi11111, user=bob, attrs=0, expired=false]
```

## 핵심 포인트

1. **AUTO 모드**: 세션 변경 즉시 영속화
2. **다중 Map 활용**: sessions + user_sessions 인덱스
3. **Lazy 만료**: 조회 시점에 만료 체크
4. **사용자당 단일 세션**: 기존 세션 자동 무효화

## 확장 아이디어

- 백그라운드 정리 스레드
- 세션 이벤트 리스너
- 분산 세션 (외부 동기화)
- 세션 복제/백업
- 세션 통계 (생성/만료/활성)
