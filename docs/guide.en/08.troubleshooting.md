---
name: Troubleshooting
description: Common problems and solutions when using FxStore
---

# Troubleshooting

## Store Opening Issues

### Store Won't Open

**Symptom**: `FxException(IO)` thrown

**Causes and Solutions**:

1. **File Path Error**
   ```java
   // Error: Non-existent directory
   FxStore.open(Paths.get("/nonexistent/dir/data.fx"));

   // Solution: Create directory first
   Files.createDirectories(Paths.get("/mydir"));
   FxStore.open(Paths.get("/mydir/data.fx"));
   ```

2. **File Permission Issue**
   ```bash
   # Solution: Check file permissions
   chmod 644 data.fx
   ```

3. **File in Use by Another Process**
   ```java
   // Solution: Use FileLockMode.NONE (warning: no concurrent writes)
   FxOptions options = FxOptions.defaults()
       .withFileLock(FileLockMode.NONE)
       .build();
   ```

### File is Corrupted

**Symptom**: `FxException(CORRUPTED)` thrown

**Solution**:
1. Restore from backup
2. Run `verify()` to check corruption extent
3. Create new Store if severely corrupted

## Data Storage Issues

### Data Not Persisting

**Symptom**: Data missing after restart

**Causes and Solutions**:

1. **Missing commit() in BATCH Mode**
   ```java
   // Error
   map.put(1L, "value");
   store.close();  // No commit!

   // Solution
   map.put(1L, "value");
   store.commit();  // Explicit commit
   store.close();
   ```

2. **Using Memory Mode**
   ```java
   // Error: Memory mode is not persistent
   FxStore store = FxStore.openMemory();

   // Solution: Use file mode
   FxStore store = FxStore.open(Paths.get("data.fx"));
   ```

3. **OnClosePolicy.ROLLBACK Setting**
   ```java
   // Check
   if (options.onClosePolicy() == OnClosePolicy.ROLLBACK) {
       // Manual commit needed before close
       store.commit();
   }
   ```

### Codec Errors

**Symptom**: `FxException(CODEC_NOT_FOUND)` or `CODEC_MISMATCH`

**Solution**:
```java
// Register codec before using custom types
store.registerCodec(User.class, new UserCodec());

// Then create/open collection
NavigableMap<Long, User> users = store.createOrOpenMap(...);
```

## Performance Issues

### Slow Writes

**Causes and Solutions**:

1. **Bulk Insertion in AUTO Mode**
   ```java
   // Slow: Commit every time
   for (long i = 0; i < 1_000_000; i++) {
       map.put(i, "value");  // Each writes to disk
   }

   // Fast: BATCH mode
   FxOptions options = FxOptions.defaults()
       .withCommitMode(CommitMode.BATCH)
       .build();
   for (long i = 0; i < 1_000_000; i++) {
       map.put(i, "value");
       if (i % 100_000 == 0) store.commit();
   }
   store.commit();
   ```

2. **Using SYNC Mode**
   ```java
   // Slow
   .withDurability(Durability.SYNC)

   // Fast (reduced safety)
   .withDurability(Durability.ASYNC)
   ```

### Slow Reads

**Causes and Solutions**:

1. **Insufficient Cache**
   ```java
   // Increase cache
   FxOptions options = FxOptions.defaults()
       .withCacheBytes(256 * 1024 * 1024)  // 256MB
       .build();
   ```

2. **Page Size Mismatch**
   ```java
   // Small page for large values
   .withPageSize(PageSize.PAGE_16K)  // Increase
   ```

### Excessive Memory Usage

**Solutions**:
1. Reduce cache size
2. Periodic commits to clear buffers
3. Set memoryLimitBytes in memory mode

## Concurrency Issues

### File Lock Conflict

**Symptom**: Store opening fails from another process

**Solution**:
- Use Store from single process only
- If needed, use `FileLockMode.NONE` (no concurrent writes)

### Read Transaction Error

**Symptom**: `IllegalStateException` - transaction is closed

**Solution**:
```java
// Error: Outside transaction scope
FxReadTransaction tx = store.beginRead();
tx.close();
tx.get(map, key);  // Exception!

// Solution: Use try-with-resources
try (FxReadTransaction tx = store.beginRead()) {
    return tx.get(map, key);
}
```

## Common Error Messages

| Message | Cause | Solution |
|---------|-------|----------|
| "Collection not found" | Opening non-existent collection | Use createOrOpen |
| "Collection already exists" | Creating existing collection | Use createOrOpen |
| "Key cannot be null" | Using null key | Add null check |
| "Store is closed" | Using closed Store | Verify Store is open |
| "Codec not registered" | Unregistered type | Call registerCodec |

## Debugging Tips

### Check Statistics
```java
Stats stats = store.stats();
System.out.println("Pages: " + stats.pageCount());
System.out.println("Used: " + stats.usedBytes());
```

### Verify Integrity
```java
VerifyResult result = store.verify();
if (!result.isOk()) {
    for (VerifyError e : result.errors()) {
        System.err.println(e.kind() + ": " + e.message());
    }
}
```

### List Collections
```java
for (CollectionInfo info : store.list()) {
    System.out.println(info.name() + " (" + info.kind() + ")");
}
```
