---
name: Core Concepts
description: Explanation of FxStore's core concepts including Store, collections, codecs, and commit modes
---

# Core Concepts

> **Estimated Time**: 15 minutes
> **Level**: Beginner

This document explains the core concepts you need to know to use FxStore effectively.

## 1. Store and Collections

### Store
**Store** is the top-level container in FxStore.
- Corresponds to one file (or memory region)
- Contains multiple collections
- Created with `FxStore.open()` or `FxStore.openMemory()`

```java
// File-based store
FxStore fileStore = FxStore.open(Paths.get("data.fx"));

// Memory-based store
FxStore memoryStore = FxStore.openMemory();
```

### Collections
**Collections** are data structures **identified by name** within a Store.

| Type | Method | Use Case |
|------|--------|----------|
| Map | `createOrOpenMap()` | Key-value storage, sorting |
| Set | `createOrOpenSet()` | Unique elements, sorting |
| List | `createOrOpenList()` | Index access |
| Deque | `createOrOpenDeque()` | Double-ended queue |

```java
// Create/open collections
NavigableMap<Long, String> users = store.createOrOpenMap("users", Long.class, String.class);
NavigableSet<String> tags = store.createOrOpenSet("tags", String.class);
List<String> logs = store.createOrOpenList("logs", String.class);
Deque<String> tasks = store.createOrOpenDeque("tasks", String.class);

// Check if collection exists
boolean exists = store.exists("users");

// Delete collection
store.drop("old_collection");

// Rename collection
store.rename("old_name", "new_name");

// List all collections
List<CollectionInfo> all = store.list();
```

## 2. Codec

**Codec** serializes (encode) and deserializes (decode) Java objects to/from byte arrays.

### Built-in Codecs

FxStore provides built-in codecs for basic types:

| Type | Codec ID | Description |
|------|----------|-------------|
| `Long` | `fx:i64` | 64-bit integer |
| `Integer` | `fx:i32` | 32-bit integer |
| `Short` | `fx:i16` | 16-bit integer |
| `Byte` | `fx:i8` | 8-bit integer |
| `Double` | `fx:f64` | 64-bit floating point |
| `Float` | `fx:f32` | 32-bit floating point |
| `String` | `fx:str` | UTF-8 string |
| `byte[]` | `fx:bytes` | Byte array |

```java
// Built-in codecs are used automatically
NavigableMap<Long, String> map = store.createOrOpenMap("data", Long.class, String.class);
```

### Custom Codecs

To store custom types, implement the `FxCodec` interface:

```java
public class UserCodec implements FxCodec<User> {
    @Override
    public String id() { return "app:user"; }

    @Override
    public int version() { return 1; }

    @Override
    public byte[] encode(User user) {
        // Serialization logic
    }

    @Override
    public User decode(byte[] bytes) {
        // Deserialization logic
    }

    @Override
    public int compareBytes(byte[] a, byte[] b) {
        // Byte comparison for sorting
    }

    // Also implement equalsBytes, hashBytes...
}

// Register with store
store.registerCodec(User.class, new UserCodec());

// Use
NavigableMap<Long, User> users = store.createOrOpenMap("users", Long.class, User.class);
```

## 3. Commit Modes

FxStore provides two commit modes.

### AUTO Mode (Default)

Each write operation is **immediately saved to disk**.

```java
// AUTO mode (default)
FxStore store = FxStore.open(path);

map.put(1L, "Alice");  // Saved immediately
map.put(2L, "Bob");    // Saved immediately
// Data is safe even if crash occurs
```

**Pros**: Minimizes risk of data loss
**Cons**: Performance degradation with bulk writes

### BATCH Mode

Data is saved to disk only when `commit()` is called.

```java
// BATCH mode
FxOptions options = FxOptions.defaults()
    .withCommitMode(CommitMode.BATCH)
    .build();
FxStore store = FxStore.open(path, options);

map.put(1L, "Alice");  // Exists only in memory
map.put(2L, "Bob");    // Exists only in memory
store.commit();        // Now saved to disk

// Rollback (cancel changes since last commit)
map.put(3L, "Charlie");
store.rollback();      // "Charlie" disappears
```

**Pros**: Excellent performance for bulk writes
**Cons**: Data loss after last commit if crash occurs

### Selection Guide

| Situation | Recommended Mode |
|-----------|-----------------|
| Real-time data storage | AUTO |
| Bulk data insertion | BATCH |
| Transaction rollback needed | BATCH |
| Maximum safety | AUTO + SYNC |

## 4. Snapshots and Consistency

### COW (Copy-on-Write)

FxStore uses **COW** strategy:

1. **Copy** existing data on write
2. Apply changes to copy
3. **Atomically** replace with new version

This ensures:
- Reads are unaffected even if writes occur during reading
- Always recovers to consistent state on crash

### Read Transactions

Multiple reads can be performed from a **consistent snapshot**:

```java
try (FxReadTransaction tx = store.beginRead()) {
    // All reads in this block are from the same snapshot
    User user = tx.get(userMap, userId);
    Account account = tx.get(accountMap, user.getAccountId());
    // Unaffected by writes that occur in the middle
}
```

**Note**: Writes are not allowed within read transactions

## 5. File Structure

FxStore stores all data in a **single file**.

```
data.fx
├── Superblock (metadata)
├── Page 0
├── Page 1
├── ...
└── Page N
```

### Page Size

Data is managed in **page** units.

| Page Size | Recommended Use |
|-----------|-----------------|
| 4K (default) | General usage |
| 8K | Medium-sized values |
| 16K | Large value storage |
| 32K, 64K | Very large values |

```java
FxOptions options = FxOptions.defaults()
    .withPageSize(PageSize.PAGE_16K)
    .build();
```

## 6. Options Summary

| Option | Default | Description |
|--------|---------|-------------|
| `commitMode` | AUTO | AUTO/BATCH |
| `durability` | ASYNC | ASYNC/SYNC |
| `pageSize` | 4K | 4K/8K/16K/32K/64K |
| `cacheBytes` | 64MB | Page cache size |
| `fileLock` | PROCESS | PROCESS/NONE |
| `onClosePolicy` | ERROR | ERROR/COMMIT/ROLLBACK |

```java
FxOptions options = FxOptions.defaults()
    .withCommitMode(CommitMode.BATCH)
    .withDurability(Durability.SYNC)
    .withPageSize(PageSize.PAGE_8K)
    .withCacheBytes(128 * 1024 * 1024)  // 128MB
    .build();

FxStore store = FxStore.open(path, options);
```

## Next Steps

- [Map Tutorial](05.tutorials/01.basic-map.md): Detailed NavigableMap usage
- [BATCH Mode Tutorial](05.tutorials/05.batch-mode.md): Batch processing
- [Performance Tuning](05.tutorials/08.performance.md): Optimization techniques
